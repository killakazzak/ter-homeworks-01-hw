# Домашнее задание к занятию «Введение в Terraform»

### Цели задания

1. Установить и настроить Terrafrom.
2. Научиться использовать готовый код.

------

### Чек-лист готовности к домашнему заданию

1. Скачайте и установите **Terraform** версии >=1.8.4 . Приложите скриншот вывода команды ```terraform --version```.
   ![image](https://github.com/user-attachments/assets/26cd8c03-4f56-48eb-8cca-e4d94589d639)
3. Скачайте на свой ПК этот git-репозиторий. Исходный код для выполнения задания расположен в директории **01/src**.
   ![image](https://github.com/user-attachments/assets/0f84f305-db7e-4351-bb1f-ff48ea25f9d7)
5. Убедитесь, что в вашей ОС установлен docker.
   
   ![image](https://github.com/user-attachments/assets/1b404542-6155-46e6-8f40-01f23416436f)


------

### Инструменты и дополнительные материалы, которые пригодятся для выполнения задания

1. Репозиторий с ссылкой на зеркало для установки и настройки Terraform: [ссылка](https://github.com/netology-code/devops-materials).
2. Установка docker: [ссылка](https://docs.docker.com/engine/install/ubuntu/). 
------
### Внимание!! Обязательно предоставляем на проверку получившийся код в виде ссылки на ваш github-репозиторий!
------

### Задание 1

1. Перейдите в каталог [**src**](https://github.com/netology-code/ter-homeworks/tree/main/01/src). Скачайте все необходимые зависимости, использованные в проекте. 
2. Изучите файл **.gitignore**. В каком terraform-файле, согласно этому .gitignore, допустимо сохранить личную, секретную информацию?(логины,пароли,ключи,токены итд)
3. Выполните код проекта. Найдите  в state-файле секретное содержимое созданного ресурса **random_password**, пришлите в качестве ответа конкретный ключ и его значение.
4. Раскомментируйте блок кода, примерно расположенный на строчках 29–42 файла **main.tf**.
Выполните команду ```terraform validate```. Объясните, в чём заключаются намеренно допущенные ошибки. Исправьте их.
5. Выполните код. В качестве ответа приложите: исправленный фрагмент кода и вывод команды ```docker ps```.
6. Замените имя docker-контейнера в блоке кода на ```hello_world```. Не перепутайте имя контейнера и имя образа. Мы всё ещё продолжаем использовать name = "nginx:latest". Выполните команду ```terraform apply -auto-approve```.
Объясните своими словами, в чём может быть опасность применения ключа  ```-auto-approve```. Догадайтесь или нагуглите зачем может пригодиться данный ключ? В качестве ответа дополнительно приложите вывод команды ```docker ps```.
8. Уничтожьте созданные ресурсы с помощью **terraform**. Убедитесь, что все ресурсы удалены. Приложите содержимое файла **terraform.tfstate**. 
9. Объясните, почему при этом не был удалён docker-образ **nginx:latest**. Ответ **ОБЯЗАТЕЛЬНО НАЙДИТЕ В ПРЕДОСТАВЛЕННОМ КОДЕ**, а затем **ОБЯЗАТЕЛЬНО ПОДКРЕПИТЕ** строчкой из документации [**terraform провайдера docker**](https://docs.comcloud.xyz/providers/kreuzwerker/docker/latest/docs).  (ищите в классификаторе resource docker_image )

### Решение Задание 1

```bash
terraform init
```
![image](https://github.com/user-attachments/assets/8af9f0e9-ace0-4fc9-96a7-79be5a0f9ced)

Согласно файлу .gitignore, допустимо сохранять личную, секретную информацию в файле personal.auto.tfvars

```bash
terraform validate
```
![image](https://github.com/user-attachments/assets/59dafadf-f29d-4f11-bb96-6fa814999f8a)

```bash
terraform plan
```
![image](https://github.com/user-attachments/assets/a53650a8-5a27-42f9-b632-9aa1b65f3dfb)

```bash
terraform apply
```
![image](https://github.com/user-attachments/assets/1ebf967d-3e47-4870-bbab-e41d7501b0b7)

```bash
cat terraform.tfstate  | grep result
```
```
"result": "F28BPRO1bLkhIe5n"
```

![image](https://github.com/user-attachments/assets/3d6423ff-7ff5-4a16-a02c-547d4ad25ba0)

```bash
terraform validate
```
![image](https://github.com/user-attachments/assets/4f4c2953-f977-44ab-ae35-3ced73de98c1)

```bash
terraform validate
```

![image](https://github.com/user-attachments/assets/a33d663a-c0a3-4db4-9a87-29ff66666e9c)

```bash
docker ps
```
![image](https://github.com/user-attachments/assets/1261192c-5a7c-4443-851f-e10d1f623030)

```hcl
terraform {
  required_providers {
    docker = {
      source  = "kreuzwerker/docker"
      version = "~> 3.0.1"
    }
  }
  required_version = "~>1.8.4" /*Многострочный комментарий.
 Требуемая версия terraform */
}
provider "docker" {}

#однострочный комментарий

resource "random_password" "random_string" {
  length      = 16
  special     = false
  min_upper   = 1
  min_lower   = 1
  min_numeric = 1
}


resource "docker_image" nginx {
  name         = "nginx:latest"
  keep_locally = true
}

resource "docker_container" "nginx" {
  image = docker_image.nginx.image_id
  name  = "hello_world"

  ports {
    internal = 80
    external = 9090
  }
}
```
![image](https://github.com/user-attachments/assets/cf61fc3d-8b21-4e09-bd9a-0bdac1215708)

```
Ключ `-auto-approve` в команде `terraform apply` позволяет автоматически применять изменения в инфраструктуре без необходимости подтверждения от пользователя. Это может быть удобно в автоматизированных сценариях, таких как CI/CD, где требуется быстрое развертывание изменений без вмешательства человека. Однако использование этого ключа также несет в себе определенные риски:

1. **Необратимые изменения**: Если вы случайно внесли ошибку в конфигурацию, например, удалили важный ресурс или изменили его настройки, Terraform применит эти изменения без подтверждения, что может привести к потере данных или нарушению работы системы.

2. **Отсутствие проверки**: В обычном режиме Terraform показывает план изменений и требует подтверждения, что дает возможность пользователю проверить, что именно будет изменено. С `-auto-approve` эта проверка пропускается, и вы можете не заметить потенциально опасные изменения.

3. **Безопасность**: В случае, если конфигурация была изменена злоумышленником, автоматическое применение изменений может привести к серьезным последствиям, таким как развертывание вредоносного кода или изменение настроек безопасности.

Таким образом, использование `-auto-approve` следует ограничивать и применять только в тех случаях, когда вы уверены в своих изменениях и понимаете их последствия.
```
```bas
docker ps -a
```
![image](https://github.com/user-attachments/assets/029c1d71-72bc-41d2-99ea-3ba42e1c85d6)

```bash
terraform destroy
```
![image](https://github.com/user-attachments/assets/d8ae36d3-9945-41dd-962a-2a7d2ba7a674)

```bash
cat terraform.tfstate
```

![image](https://github.com/user-attachments/assets/9bd875a0-07fc-42a7-bc47-c048075547b4)


При уничтожении ресурсов не был удалён Docker-образ nginx:latest, так как в Terraform провайдере Docker, ресурс docker_image управляет только метаданными образа, а не самим образом на Docker Hub или локальном хосте.

Согласно документации Terraform для провайдера Docker, ресурс docker_image не удаляет образ, если он не был создан через Terraform. Вот соответствующая строка из документации:

**"The docker_image resource is used to manage Docker images. It does not delete images that are not created by Terraform."**

Таким образом, если образ nginx:latest был загружен вручную или создан другим способом, Terraform не будет его удалять при выполнении команды terraform destroy.

------

## Дополнительное задание (со звёздочкой*)

**Настоятельно рекомендуем выполнять все задания со звёздочкой.** Они помогут глубже разобраться в материале.   
Задания со звёздочкой дополнительные, не обязательные к выполнению и никак не повлияют на получение вами зачёта по этому домашнему заданию. 

### Задание 2*

1. Создайте в облаке ВМ. Сделайте это через web-консоль, чтобы не слить по незнанию токен от облака в github(это тема следующей лекции). Если хотите - попробуйте сделать это через terraform, прочитав документацию yandex cloud. Используйте файл ```personal.auto.tfvars``` и гитигнор или иной, безопасный способ передачи токена!
2. Подключитесь к ВМ по ssh и установите стек docker.
3. Найдите в документации docker provider способ настроить подключение terraform на вашей рабочей станции к remote docker context вашей ВМ через ssh.
4. Используя terraform и  remote docker context, скачайте и запустите на вашей ВМ контейнер ```mysql:8``` на порту ```127.0.0.1:3306```, передайте ENV-переменные. Сгенерируйте разные пароли через random_password и передайте их в контейнер, используя интерполяцию из примера с nginx.(```name  = "example_${random_password.random_string.result}"```  , двойные кавычки и фигурные скобки обязательны!) 
```
    environment:
      - "MYSQL_ROOT_PASSWORD=${...}"
      - MYSQL_DATABASE=wordpress
      - MYSQL_USER=wordpress
      - "MYSQL_PASSWORD=${...}"
      - MYSQL_ROOT_HOST="%"
```

6. Зайдите на вашу ВМ , подключитесь к контейнеру и проверьте наличие секретных env-переменных с помощью команды ```env```. Запишите ваш финальный код в репозиторий.

### Решение Задание 2*

```hcl
terraform {
  required_providers {
    yandex = {
      source = "yandex-cloud/yandex"
    }
    random = {
      source = "hashicorp/random"
    }
  }
  required_version = ">= 0.130"
}

provider "yandex" {
  service_account_key_file = "/root/yandex-cloud/key.json"
  cloud_id                 = "b1gp6qjp3sreksmq9ju1"
  folder_id                = "b1g3hhpc4sj7fmtmdccu"
  zone                     = "ru-central1-a"
}

resource "random_password" "mysql_root_password" {
  length  = 16
  special = true
}

resource "random_password" "mysql_user_password" {
  length  = 16
  special = true
}

resource "yandex_compute_instance" "vm" {
  count = 1

  name = "vm-${count.index + 1}"
  zone = "ru-central1-a"

  resources {
    core_fraction = 5
    cores  = 2
    memory = 1
  }
  
  scheduling_policy {
    preemptible = true
  }

  boot_disk {
    initialize_params {
      image_id = "fd8tvc3529h2cpjvpkr5" # ID образа, например, Ubuntu
    }
  }

  network_interface {
    subnet_id = "e9bang8tpj4mbo92gvr6"
    nat       = true
  }

  metadata = {
    "ssh-keys" = file("./ssh-keys.txt")
    "user-data" = <<-EOF
      #!/bin/bash
      apt-get update
      apt-get install -y docker.io
      systemctl start docker
      systemctl enable docker
      
      # Добавление пользователя tenda
      useradd -m -s /bin/bash tenda
      echo "tenda:$(openssl rand -base64 12)" | chpasswd
      usermod -aG sudo tenda
      echo "tenda ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers

      # Запуск контейнера MySQL
      docker run -d \
        --name mysql \
        -e "MYSQL_ROOT_PASSWORD=${random_password.mysql_root_password.result}" \
        -e "MYSQL_DATABASE=wordpress" \
        -e "MYSQL_USER=wordpress" \
        -e "MYSQL_PASSWORD=${random_password.mysql_user_password.result}" \
        -p 127.0.0.1:3306:3306 \
        mysql:8
    EOF
  }
}

output "instance_ips" {
  value = [for instance in yandex_compute_instance.vm : instance.network_interface[0].nat_ip_address]
}
```
```bash
docker exec -it mysql env
netstat -tulpn
```
![image](https://github.com/user-attachments/assets/bb6ea113-00f3-46de-8ff7-9dc0de3ae6ff)


### Задание 3*
1. Установите [opentofu](https://opentofu.org/)(fork terraform с лицензией Mozilla Public License, version 2.0) любой версии
2. Попробуйте выполнить тот же код с помощью ```tofu apply```, а не terraform apply.

### Решение Задание 3*



------

### Правила приёма работы

Домашняя работа оформляется в отдельном GitHub-репозитории в файле README.md.   
Выполненное домашнее задание пришлите ссылкой на .md-файл в вашем репозитории.

### Критерии оценки

Зачёт ставится, если:

* выполнены все задания,
* ответы даны в развёрнутой форме,
* приложены соответствующие скриншоты и файлы проекта,
* в выполненных заданиях нет противоречий и нарушения логики.

На доработку работу отправят, если:

* задание выполнено частично или не выполнено вообще,
* в логике выполнения заданий есть противоречия и существенные недостатки. 
